<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <title>CMPT384 - World Pollution Visualization</title>
        <script type="text/javascript" src="d3.v5.min.js"></script>
    </head>

    <body>
        <div class="button-container">
            <button id="btn-PM10">PM10</button>
            <button id="btn-PM2dot5">PM2.5</button>
        </div>
    </body>
    <script type="text/javascript">
        //Width and height
        var w = 800;
        var h = 600;

        var showPM10 = false;

        var pollutionData;
        var geoPollutionData;
        var mapPolygons;

        //set up button listeners
        document.getElementById('btn-PM10').addEventListener('click', function() {
            showPM10 = true;
            changePMValue();
        });
        document.getElementById('btn-PM2dot5').addEventListener('click', function() {
            showPM10 = false;
            changePMValue();
        });

        // Zooming
        var attachZoom = d3.zoom().on('zoom', function(d) {
            d3.select('g').attr('transform', d3.event.transform);
        });

        //Define map projection
        var projection = d3.geoMercator()
            .translate([w / 2, h / 2 + 100])
            .scale([123]);
        // translate the map to center it and scale.

        //Define quantize scale to sort data values into buckets of color
        var blues = d3.scaleQuantize().range(d3.schemeBlues[9]);
        var oranges = d3.scaleQuantize().range(d3.schemeOranges[9]);

        //Define path generator
        var path = d3.geoPath()
            .projection(projection);

        //Create SVG element
        var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h)
            // prevent user disorientation
            .style('border', '2px solid black')
            .call(attachZoom);

        var svg = svg.append('g');

        //Load in pollution data
        d3.csv("pollution_dataset.csv").then(function(data) {

            pollutionData = data;

            //Set input domain for color scale
            // PM 2.5
            blues.domain([
                d3.min(data, function(d) {
                    return +d.pm2dot5;
                }),
                d3.max(data, function(d) {
                    return +d.pm2dot5;
                })
            ]);
            
            // PM 10
            oranges.domain([
                d3.min(data, function(d) {
                    return d.pm10;
                }),
                d3.max(data, function(d) {
                    return d.pm10;
                })
            ]);


            //Load in GeoJSON data
            d3.json("globe.geo.json").then(function(json) {
                mapPolygons = json;
                drawMap();

                //Load in cities data
                d3.csv("worldcities.csv").then(function(cities) {

                    // Merge the datasets
                    // O(n^2)
                    for (var i = 0; i < pollutionData.length; i++) {

                        var dataCity = pollutionData[i]["City/Town"];
                        var dataPM2dot5 = parseInt(pollutionData[i].pm2dot5);
                        var dataPM10 = parseInt(pollutionData[i].pm10);

                        //Find the corresponding state inside the worldcities
                        for (var j = 0; j < cities.length; j++) {

                            var worldcitiesCity = cities[j].city_ascii;

                            if (dataCity == worldcitiesCity) {

                                //Copy the data value into the JSON
                                cities[j].pm10 = dataPM10;
                                cities[j].pm2dot5 = dataPM2dot5;

                                //Stop looking through the JSON
                                break;

                            }
                        }
                    }

                    geoPollutionData = cities;
                    drawPollutionData();
                });

            });
        });

        function drawMap() {
            if(!mapPolygons) {
                return;
            }

            //Bind data and create one path per GeoJSON feature
            svg.selectAll("path")
                .data(mapPolygons.features)
                .enter()
                .append("path")
                .attr("d", path)
                .style("fill", "grey");
        }

        function drawPollutionData() {
            if(!geoPollutionData) {
                return;
            }

            svg.selectAll("circle")
                .data(geoPollutionData.filter(function(d){
                    return showPM10 ? d.pm10 : d.pm2dot5;
                }))
                .enter()
                .append("circle")
                .attr("cx", function(d) {
                    return projection([d.lng, d.lat])[0];
                })
                .attr("cy", function(d) {
                    return projection([d.lng, d.lat])[1];
                })
                .attr("r", 1)
                .style("fill", function(d) {
                    return showPM10 ? blues(d.pm10) : oranges(d.pm2dot5);
                })
                .append("svg:title")
                .text(function(d) { return d.city; });
        }

        function changePMValue() {
            if(!geoPollutionData) {
                return;
            }

            svg.selectAll("circle")
                .data(geoPollutionData.filter(function(d){
                    return showPM10 ? d.pm10 : d.pm2dot5;
                }))
                .style("fill", function(d) {
                    return showPM10 ? blues(d.pm10) : oranges(d.pm2dot5);
                });
        }

    </script>

</html>